name: Continuous Integration

# Bu workflow'un ne zaman çalışacağını tanımlayan trigger'lar
on:
  # Normal push ve pull request'lerde çalış
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]
  
  # DÜZELTME: Başka bir workflow tarafından çağrılmasına izin ver
  workflow_call:

jobs:
  test_and_lint:
    name: Test and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Run linter (clippy)
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: Run unit tests
        run: cargo test --workspace

  integration_test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: test_and_lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run integration tests with Docker Compose
        working-directory: ./tests
        run: docker compose -f docker-compose.integration.yml up --build --exit-code-from tester